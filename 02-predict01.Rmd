# 学科预测 {#predict}
 
本章的主要工作是，计算并预测川师未来三年进入双一流学科的概率。
可能一点意义也没有

## 统计方法
- 贝叶斯数据分析
- 模型不好怎么办？
- log10 scale


关于模型，学科的发展和很多方面都有关系，因此建立一个完全正确的模型是不可能的。正如英国统计学家George E. P. Box所说，所有模型都是错的，但其中有些是有用的。
所以与其去建立复杂的模型，并给解释带来更多困扰，不如就从最简单的出发。

```{r}
focus <- c("Computer Science", "Engineering", "Chemistry", "Materials Science")

d <- univ_discip_timeserial_2000_to_2019 %>% 
	filter(univ_cn == "四川师范大学") %>% 
	filter(discipline %in% focus) 
d
```
```{r}
d1 <- d %>% 
	select(discipline_cn, year, n_paper, n_cited) %>% 
	complete(discipline_cn, year) %>% 
    group_by(discipline_cn) %>% 
    mutate(
	cum_cited = slider::slide_dbl(n_cited, sum, na.rm = TRUE, .before = 9, .step = 1, .complete = TRUE)
) %>% 
	ungroup()
d1
```




```{r}
d1 %>% 
	filter(!is.na(cum_cited)) %>% 
	ggplot(aes(x = year, y = cum_cited)) +
	geom_point() +
	geom_smooth(method = lm, se = FALSE) +
	facet_wrap(vars(discipline_cn), scales = "free_y") +
	scale_x_continuous(breaks = seq(2009, 2019, by = 2),
					   labels = seq(2009, 2019, by = 2)
					   )
```




```{r}
tb <- tibble(
	year = c(2020)
)

```


```{r}
d_eng <- d1 %>%  
	filter(discipline_cn %in% "工程学") %>% 
	filter(between(year, 2009, 2019)) 
d_eng
```
弥补2012-2013年期间的短板有所下滑，从而导致

```{r}
b_eng <- brms::brm(cum_cited ~ year,  data = d_eng)
```


```{r}
b_eng
plot(b_eng)
```


```{r}
post_draw <- tb %>% add_predicted_draws(b_eng) 

prob_pred <- post_draw %>% 
	group_by(year) %>% 
	summarise(
		pred_mean = mean(.prediction),
		prob_above_line = mean(.prediction >= 2843)
	)
prob_pred
```

```{r}
post_draw %>% 
	ggplot(aes(x = .prediction, y = factor(year), fill = stat(x > 2843))) +
	stat_halfeyeh() +
	geom_vline(xintercept = 2843, linetype = "dashed", size = 2,
			   color = "red") +
	scale_fill_manual(values = c("gray80", "skyblue")) #+
#scale_x_continuous(limits = c(150, 200))
```


```{r}
post_draw %>% 
	ggplot(
		aes(x = year, y = .prediction, fill = stat(y > 2843)) 
	) +
	stat_eye(side = "right") +
	geom_point(data = d_eng, aes(x = year, y = cum_cited)) +
	geom_hline(yintercept = 2843, linetype = "dashed", size = 1,
			   color = "red") +
	scale_fill_manual(values = c("gray80", "skyblue")) +
	annotate("text", x = 2012, y = 3000, 
			 label = "进入双一流学科的阈值线", size = 4, color = "red") +
	scale_x_continuous(breaks = c(seq(2009, 2019, by = 2), 2020),
					   labels = c(seq(2009, 2019, by = 2), 2020)
					   )
```

## 数学学科

## 物理学科

### 数据


```{r}
set.seed(1024)
N <- 20
sigma <- 5
x <- c(2000:2019)
y <- rnorm(N, -2000 + 2.5 * x, sigma)

d2 <- 
  tibble::tibble(
  year = x,
  n_cited = y
)

d2 %>% 
  ggplot(aes(x = year, y = n_cited)) +
  geom_point()
```


```{r}
# predict future three years
tb <- tibble(
	year = c(2020, 2021, 2022)
)
```



### 先验概率
```{r, eval = FALSE}
ggplot(
  data = d2,
  aes(x = weight, y = height)
) +
  geom_point(shape = 1, size = 2) +
  theme_bw() +
  theme(panel.grid = element_blank())



# prior for mu $\text{Normal}(178, 100)$
ggplot(
  data = tibble(x = seq(from = 100, to = 250, by = .1)),
  aes(x = x, y = dnorm(x, mean = 178, sd = 20))
) +
  geom_line() +
  ylab("density")


# prior for beta $\text{Normal}(0, 10)$
tibble(beta = -40:40) %>%
  mutate(density = dnorm(beta, mean = 0, sd = 10)) %>%
  ggplot(aes(x = beta, ymin = 0, ymax = density)) +
  geom_ribbon(size = 0, fill = "royalblue") +
  scale_y_continuous(NULL, breaks = NULL) +
  xlab(expression(beta)) +
  theme(panel.grid = element_blank())

# prior for sigma $\text{Uniform}(0, 50)$
tibble(x = seq(from = -10, to = 60, by = .1)) %>%

  ggplot(aes(x = x, y = dunif(x, min = 0, max = 50))) +
  geom_line() +
  scale_y_continuous(NULL, breaks = NULL) +
  theme(panel.grid = element_blank())
```



```{r}
b4.3 <-
  brm(
    data = d2,
    family = gaussian,
    n_cited ~ 1 + year,
    #prior = c(
    #  prior(normal(178, 100), class = Intercept),
    #  prior(normal(2.5, 10), class = b),
    #  prior(uniform(0, 50), class = sigma)
    #),
    iter = 41000, warmup = 40000, chains = 4, cores = 4,
    seed = 1024,
    control = list(adapt_delta = 0.99, 
                 max_treedepth = 13),
    file = "fits/b04.03"
  )
```


```{r, eval=FALSE}
plot(b4.3)
```


```{r}
summary(b4.3)
```


```{r, eval=FALSE}
#b4.3$prior
prior_summary(b4.3)
```



```{r, eval=FALSE}
brms::posterior_summary(b4.3)
brms::posterior_summary(b4.3) %>%
  as.data.frame() %>%
  rownames_to_column()

brms::posterior_samples(b4.3) %>% as_tibble()
brms::posterior_samples(b4.3, add_chain = T) %>% as_tibble()

# same as
tidybayes::get_variables(b4.3)
tidybayes::spread_draws(b4.3, b_Intercept, b_weight, sigma, lp__)
```






```{r}
# 这里的add_predicted_draws  = predict() + as_tibble() + pivot_longer()
post_draw <- tb %>% tidybayes::add_predicted_draws(b4.3)
post_draw
```


```{r}
prob_pred <- post_draw %>%
  group_by(year) %>%
  summarise(
    pred_mean = mean(.prediction),
    prob_above_line = mean(.prediction >= 3040)
  )
prob_pred
```






```{r, fig.asp = 0.618}
# plot original data and predict data together
library(ggforce)
desc <- "未来三年进入双一流学科的概率"


post_draw %>% 
	ggplot(
		aes(x = year, y = .prediction, fill = stat(y > 3040)) 
	) +
  stat_eye(side = "right") +
  geom_point(data = d2, aes(x = year, y = n_cited)) +
  geom_hline(
    yintercept = 3040, linetype = "dashed", size = 1,
    color = "red"
  ) +
  scale_fill_manual(values = c("gray80", "skyblue")) +
  annotate("text",
    x = 2004, y = 3040 + 3,
    label = "进入双一流学科的阈值线", size = 4, color = "red"
  ) +
  geom_mark_ellipse(aes(
    x = 2020, y = 3060,
    label = "贝叶斯预测", description = desc
  ),
  # label.family = "Space Mono",
   label.fontsize = 11,
   label.colour = c("#CC79A7", "black"),
   label.fill = NA,
   label.buffer = unit(0.1, "mm"), # 标签与指定xy点的间距
   colour = NA,
   fill = NA
  ) +
  geom_text(data = prob_pred, aes(
    x = year,
    y = pred_mean,
    label = scales::percent(prob_above_line)
  )) +
  scale_y_continuous(
  	expand = expansion(mult = c(0, NA))
  	) +
 scale_x_continuous(
 	breaks = c(2000:2022),
 	labels = c(2000:2022),
 	expand = expansion(mult = c(0.05, 0.1))
 ) + 
  theme_classic() +
  theme(legend.position = "none",
  	  axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  	  ) +
  labs(
    title = "物理学科未来三年进入双一流学科的概率",
    subtitle = "基于引文量的贝叶斯预测",
    x = "时间（年）",
    y = "被引量"
  )
```



## 化学学科
## 工程学科

## 计算机学科

具体参考 <https://mc-stan.org/docs/2_22/stan-users-guide/prediction-forecasting-and-backcasting.html>

```{r}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
Sys.setenv(LOCAL_CPPFLAGS = "-march=native")




# put into a list
stan_dat <- list(
	N = nrow(d2),
	x = d2$year,
	y = d2$n_cited,
	M = nrow(tb),
	new_x = tb$year
)




fit <- stan(file = "./models/simple.stan", 
			data = stan_dat,
			iter = 41000, 
			chains = 4, 
			warmup = 40000, 
			control = list(adapt_delta = 0.99, 
                           max_treedepth = 13),
			cores = 4)
```




```{r}
fit
```





```{r, eval=FALSE}
plot(fit, pars = c("alpha", "beta"))
```


```{r, eval=FALSE}
stan_trace(fit)
```


```{r, eval=FALSE}
stan_plot(fit, pars = c("alpha", "beta"))
```


```{r, eval=FALSE}
stan_hist(fit, pars = c("alpha", "beta"))
```


```{r, eval=FALSE}
stan_dens(fit, pars = c("alpha", "beta"))
```


```{r, eval=FALSE}
get_posterior_mean(fit)
as.data.frame(fit) %>% as_tibble()
```


```{r, eval=FALSE}
fit %>% tidybayes::spread_draws(alpha, beta)

fit %>% tidybayes::spread_draws(new_y[n]) 
fit %>% tidybayes::spread_draws(new_y[weight]) 
fit %>% tidybayes::spread_draws(new_y[condition]) 

fit %>% tidybayes::spread_draws(new_y[i]) %>% 
	median_qi()
```


```{r, eval=FALSE}
fit %>%
	spread_draws(beta) %>%
	ggplot(aes(y = 0, x = beta, fill = stat(x > 1.5))) +
	stat_halfeyeh() +
	geom_vline(xintercept = 1.5, linetype = "dashed") +
	scale_fill_manual(values = c("gray80", "skyblue"))
```

### 预测
```{r}
library(tidybayes)

# stanfit模型不能用add_predicted_draws(fit)， 很遗憾
# 只有先写在.stan文件里， 预测写在generated quantities里

post_draw1 <- fit %>% tidybayes::spread_draws(new_y[condition]) 
post_draw1
```


```{r}
post_draw2 <- post_draw1 %>% 
	ungroup() %>% 
	mutate(
	year = case_when(
		condition == 1 ~  2020,
		condition == 2 ~  2021,
		condition == 3 ~  2022,
		TRUE ~ NA_real_
	)
)
post_draw2
```

```{r}
prob_pred1 <- post_draw2 %>% 
	group_by(year) %>% 
	summarise(
		pred_mean = mean(new_y),
		prob_above_line = mean(new_y >= 3040)
	)
prob_pred1
```


```{r}
post_draw2 %>% 
	ggplot(aes(x = new_y, y = factor(year), fill = stat(x > 3040))) +
	stat_halfeyeh() +
	geom_vline(xintercept = 3040, linetype = "dashed", size = 2,
			   color = "red") +
	scale_fill_manual(values = c("gray80", "skyblue")) 
```



```{r}
post_draw2 %>% 
	ggplot(
		aes(x = factor(year), y = new_y, fill = stat(y > 3040)) 
	) +
	stat_eye(side = "right") +
	geom_hline(yintercept = 3040, linetype = "dashed", size = 2,
			   color = "red") +
	scale_fill_manual(values = c("gray80", "skyblue"))
```




```{r, fig.asp = 0.816}
# plot original data and predict data together
library(ggforce)
desc <- "未来三年进入双一流学科的概率"


post_draw2 %>% 
	ggplot(
		aes(x = year, y = new_y, fill = stat(y > 3040)) 
	) +
  stat_eye(side = "right") +
  geom_point(data = d2, aes(x = year, y = n_cited)) +
  geom_hline(
    yintercept = 3040, linetype = "dashed", size = 1,
    color = "red"
  ) +
  scale_fill_manual(values = c("gray80", "skyblue")) +
  annotate("text",
    x = 2004, y = 3040 + 3,
    label = "进入双一流学科的阈值线", size = 4, color = "red"
  ) +
  geom_mark_ellipse(aes(
    x = 2020, y = 3060,
    label = "贝叶斯预测", description = desc
  ),
  # label.family = "Space Mono",
   label.fontsize = 11,
   label.colour = c("#CC79A7", "black"),
   label.fill = NA,
   label.buffer = unit(0.1, "mm"), # 标签与指定xy点的间距
   colour = NA,
   fill = NA
  ) +
  geom_text(data = prob_pred1, aes(
    x = year,
    y = pred_mean,
    label = scales::percent(prob_above_line)
  )) +
  scale_y_continuous(
  	expand = expansion(mult = c(0, NA))
  	) +
 scale_x_continuous(
 	breaks = c(2000:2022),
 	labels = c(2000:2022),
 	expand = expansion(mult = c(0.05, 0.1))
 ) + 
  theme_classic() +
  theme(legend.position = "none",
  	  axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  	  ) +
  labs(
    title = "物理学科未来三年进入双一流学科的概率",
    subtitle = "基于引文量的贝叶斯预测",
    x = "时间（年）",
    y = "被引量"
  )

```

## 其他学科
如果需要了解其他学科的信息，请联系本文作者^[38552109@qq.com]
