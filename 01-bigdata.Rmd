# 川师大数据 {#bigdata}

```{r}
d <- univ_discip_timeserial %>% 
	filter(	discipline != "ALL") %>% 
	drop_na()
d
```





## 全景对比
```{r, eval = FALSE}
d <- tidyr::crossing(
	school = c("北京师大", "华南师大", "杭州师大", "四川师大", "陕西师大"),
	discipline = c("物理", "化学", "数学", "工程"),
	year = c(2000:2019)
) %>% 
  group_by(school, discipline) %>%
  mutate(
    n_paper = cumsum(runif(20, 0, 100))
  ) %>%
  ungroup()

d
```



```{r}
# without gghighlight

highlight_school <- c("北京师范大学", "四川师范大学")

d1 <- d %>%
  group_by(school) %>%
  mutate(
    end_label = ifelse(year == max(year), school, NA_character_)
  ) %>%
  mutate(
    end_label = case_when(
      school %in% highlight_school ~ end_label,
      TRUE ~ NA_character_
    ),
    color_group = case_when(
      school %in% highlight_school ~ school,
      TRUE ~ "ZZOTHER"
    )
  ) %>%
  ungroup()
d1
```




```{r, fig.height = 8, fig.width = 6}
d1 %>% 
	mutate(school = factor(school) %>% 
		   	       fct_relevel("北京师范大学", "四川师范大学", after = Inf)
		   ) %>% 
	
  ggplot(aes(
    x = year, y = n_paper,
    color = color_group, label = end_label,
    group = school
  )) +
  geom_line(size = 0.8) +
  geom_point(data = . %>% filter(!is.na(end_label)),
  		   aes(fill = end_label),
  		   shape = 21, size = 2, 
  		   color = "white") +
  geom_text_repel(
    nudge_x = 1.1,
    nudge_y = 0.1,
    segment.color = NA
  ) +
  scale_color_manual(
  	values = c("北京师范大学" = "#195F90FF", 
  			   "四川师范大学" = "#D76500FF", 
  			    "ZZOTHER" = "gray80")
  	) +
  scale_fill_manual(
  	values = c("北京师范大学" = "#195F90FF", 
  			   "四川师范大学" = "#D76500FF", 
  			    "ZZOTHER" = "gray80")
  	) +
  guides(color = FALSE) +
  facet_wrap(vars(discipline), scales = "free", ncol = 2) +
  #theme_minimal() +
  #myriad::theme_myriad(base_family = "wqy-microhei") +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = c(seq(2000, 2019, by = 4), 2019) ) +
  labs(
    x = NULL, y = NULL,
    title = "label for each facet"
  ) 
```


```{r}
ggsave("p.pdf", height = 8, width = 6)
```


use gghighlight
```{r}
d %>% 
	ungroup() %>% 
	ggplot(aes(x = year, y = n_paper, color = school)) +
	geom_line() +
	facet_wrap(vars(discipline), scales = "free", ncol = 2) +
     gghighlight(school %in% c("北京师范大学", "四川师范大学"),
 			 calculate_per_facet = TRUE,
 			 use_direct_label = TRUE,
 			 label_key = school,
             keep_scales = TRUE
 			 ) +
	
	labs(title = "各校",
		 x = NULL,
		 y = NULL) #+
	#theme(legend.position = "none")
```





横向比较top30所师范类高校的学科发展情况

- 全景大图
高亮的（包括川师在内的四个学校）类似R4DS中的eda_covid2019
吸取[Kieran Healy大神的配色方案](https://github.com/kjhealy/covid) 

- 学科小图


```{r}
state_cols <- c("gray70",
                prismatic::clr_darken(paletteer::paletteer_d("ggsci::category20_d3"), 0.2))
scales::show_col(state_cols)
```
```{r}
d1 %>%
  ggplot(aes(
    x = year, y = n_paper,
    color = color_group, label = end_label,
    group = school
  )) +
  geom_line(size = 0.8) +
  geom_text_repel(
    force        = 1,
    nudge_x      = 0.25,
    direction    = "y",
    hjust        = 1,
    segment.size = 0.2
  )  +
  scale_color_manual(
  	values = c("北京师大" = "#195F90FF", 
  			   "四川师大" = "#D76500FF", 
  			    "ZZOTHER" = "gray70")
  	) +
  guides(color = FALSE) +
  facet_wrap(vars(discipline), scales = "free_x") +
  labs(
    x = NULL, y = NULL,
    title = "label for each facet"
  ) +
   theme_minimal()

```
## one in percent
```{r}
focus_discipline <- c("工程学")

univ_discip_summary %>% 
	filter(discipline_cn %in% focus_discipline) %>% 
	arrange(-cum_cited)

```

```{r}
focus_discipline <- c("工程学")
label_school <- c("四川师范大学", "北京师范大学", "南京师范大学", 
				  "杭州师范大学", "华南师范大学", "陕西师范大学")

univ_discip_summary %>% 
	filter(discipline_cn %in% focus_discipline) %>% 
	mutate(
    label = ifelse(school %in% label_school, school, "")
  ) %>%
	
  ggplot(aes(x = cum_paper, y = cum_cited)) +
  geom_point(
    size = 3.5,
    alpha = .9,
    shape = 21,
    col = "white",
    fill = "#0162B2"
  ) +
  geom_text_repel(
    aes(label = label),
    size = 4.5,
    point.padding = .2,
    box.padding = .3,
    force = 1,
    min.segment.length = 0
  ) +
 geom_hline(aes(yintercept = Threshold0326)) +
 annotate("text", x = 1250, y = 3200, 
			 label = "进入双一流学科的阈值线", size = 4, color = "red") +
  theme_minimal(14) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  ) +
  labs(
  	title = "师范类院校工程学科进入前1%ESI学科",
	subtitle = "ESI数据库2020年03月26日数据",
    x = "累积发文量(2010-2020)",
    y = "累积引文量(2010-2020)"
  )
	
```
```{r}
ggsave("mypdf.pdf", height = 6, width = 8)
```


## 学科对比

分面各校，高亮川师  

现在我们可以试试 **bookdown** 的一些初级功能了，例如图表。图 \@ref(fig:hello) 是一幅无趣的散点图，表 \@ref(tab:iris) 是一份枯燥的数据。

```{r hello, fig.cap='雷猴啊，散点图！', out.width='90%'}
par(mar = c(4, 4, 1, .1))
plot(cars, pch = 19)
```

```{r iris}
knitr::kable(
  head(iris), caption = '雷猴啊，iris 数据！',
  booktabs = TRUE
)
```

就这样，你可以一直编下去，直到编不下去。